"""
Bedrock AgentCore Vulnerability Management System
A multi-agent system addressing organizational VM roadblocks
"""
import os
from typing import Dict, List, Any
from bedrock_agentcore.runtime import BedrockAgentCoreApp
from bedrock_agentcore.memory.integrations.strands.config import AgentCoreMemoryConfig, RetrievalConfig
from bedrock_agentcore.memory.integrations.strands.session_manager import AgentCoreMemorySessionManager
from strands import Agent
from strands_tools.code_interpreter import AgentCoreCodeInterpreter

app = BedrockAgentCoreApp()

# Configuration
MEMORY_ID = os.getenv("BEDROCK_AGENTCORE_MEMORY_ID")
REGION = os.getenv("AWS_REGION", "us-west-2")
MODEL_ID = "us.anthropic.claude-3-7-sonnet-20250219-v1:0"

class VulnerabilityManagementOrchestrator:
    """Main orchestrator for the vulnerability management system"""
    
    def __init__(self, session_id: str, memory_config: AgentCoreMemoryConfig):
        self.session_id = session_id
        self.memory_config = memory_config
        self.session_manager = AgentCoreMemorySessionManager(memory_config, REGION)
        self.code_interpreter = AgentCoreCodeInterpreter(
            region=REGION,
            session_name=session_id,
            auto_create=True
        )
        
        # Initialize specialized agents
        self.asset_discovery_agent = self._create_asset_discovery_agent()
        self.risk_prioritization_agent = self._create_risk_prioritization_agent()
        self.resource_optimization_agent = self._create_resource_optimization_agent()
        self.collaboration_agent = self._create_collaboration_agent()
        self.strategic_planning_agent = self._create_strategic_planning_agent()
        self.legacy_system_agent = self._create_legacy_system_agent()
        self.patch_management_agent = self._create_patch_management_agent()

    def _create_asset_discovery_agent(self) -> Agent:
        """Agent focused on complete asset visibility"""
        return Agent(
            model=MODEL_ID,
            session_manager=self.session_manager,
            system_prompt="""You are an Asset Discovery Specialist agent. Your role is to:

1. ASSET INVENTORY MANAGEMENT:
   - Analyze network scans, cloud configurations, and system inventories
   - Identify shadow IT and unmanaged assets
   - Map asset relationships and dependencies
   - Track asset lifecycle and ownership

2. BLIND SPOT ELIMINATION:
   - Cross-reference multiple data sources (CMDB, cloud APIs, network discovery)
   - Identify gaps in asset visibility
   - Recommend discovery tools and techniques
   - Create comprehensive asset maps

3. CONTINUOUS MONITORING:
   - Set up automated asset discovery workflows
   - Monitor for new assets and configuration changes
   - Maintain real-time asset inventory accuracy
   - Generate asset visibility reports

Use code execution to analyze asset data, create visualizations, and generate actionable insights.
Focus on practical, implementable solutions for improving asset visibility.""",
            tools=[self.code_interpreter.code_interpreter]
        )

    def _create_risk_prioritization_agent(self) -> Agent:
        """Agent for intelligent vulnerability prioritization"""
        return Agent(
            model=MODEL_ID,
            session_manager=self.session_manager,
            system_prompt="""You are a Risk Prioritization Specialist agent. Your role is to:

1. VULNERABILITY ANALYSIS:
   - Process vulnerability scan results from multiple sources
   - Apply CVSS scoring with business context
   - Identify false positives and reduce noise
   - Correlate vulnerabilities with threat intelligence

2. BUSINESS IMPACT ASSESSMENT:
   - Map vulnerabilities to business-critical assets
   - Consider asset exposure and attack paths
   - Factor in compensating controls
   - Assess potential business impact

3. PRIORITIZATION FRAMEWORK:
   - Create risk-based prioritization matrices
   - Implement dynamic scoring based on threat landscape
   - Generate actionable remediation roadmaps
   - Provide clear justification for priorities

Use data analysis to create sophisticated prioritization models and visualizations.
Focus on reducing overwhelming volume to manageable, high-impact actions.""",
            tools=[self.code_interpreter.code_interpreter]
        )

    def _create_resource_optimization_agent(self) -> Agent:
        """Agent for resource and budget optimization"""
        return Agent(
            model=MODEL_ID,
            session_manager=self.session_manager,
            system_prompt="""You are a Resource Optimization Specialist agent. Your role is to:

1. RESOURCE ANALYSIS:
   - Assess current team capacity and skills
   - Analyze budget allocation and spending patterns
   - Identify resource bottlenecks and inefficiencies
   - Map resource needs to vulnerability priorities

2. OPTIMIZATION STRATEGIES:
   - Recommend automation opportunities
   - Suggest tool consolidation and integration
   - Propose skill development programs
   - Create resource allocation models

3. ROI CALCULATION:
   - Calculate cost of vulnerabilities vs. remediation
   - Demonstrate value of security investments
   - Create business cases for additional resources
   - Track and report on optimization metrics

Use financial modeling and data analysis to optimize resource utilization.
Focus on maximizing security outcomes within budget constraints.""",
            tools=[self.code_interpreter.code_interpreter]
        )

    def _create_collaboration_agent(self) -> Agent:
        """Agent for breaking down silos and improving communication"""
        return Agent(
            model=MODEL_ID,
            session_manager=self.session_manager,
            system_prompt="""You are a Collaboration Facilitator agent. Your role is to:

1. COMMUNICATION BRIDGE:
   - Translate technical vulnerabilities into business language
   - Create stakeholder-specific reports and dashboards
   - Facilitate cross-team meetings and decisions
   - Establish clear communication channels

2. WORKFLOW INTEGRATION:
   - Map current processes across IT, security, and development
   - Identify collaboration bottlenecks and delays
   - Design integrated workflows and handoffs
   - Implement shared tools and platforms

3. ACCOUNTABILITY FRAMEWORK:
   - Define clear roles and responsibilities
   - Create SLAs and performance metrics
   - Establish escalation procedures
   - Track collaboration effectiveness

Focus on practical solutions that improve team coordination and reduce delays.
Create actionable plans for better cross-functional collaboration.""",
            tools=[self.code_interpreter.code_interpreter]
        )

    def _create_strategic_planning_agent(self) -> Agent:
        """Agent for long-term strategic planning"""
        return Agent(
            model=MODEL_ID,
            session_manager=self.session_manager,
            system_prompt="""You are a Strategic Planning Specialist agent. Your role is to:

1. MATURITY ASSESSMENT:
   - Evaluate current vulnerability management maturity
   - Benchmark against industry standards
   - Identify gaps and improvement opportunities
   - Create maturity roadmaps

2. STRATEGIC PLANNING:
   - Develop long-term vulnerability management strategy
   - Align security investments with business objectives
   - Create multi-year improvement plans
   - Balance proactive vs. reactive approaches

3. VALUE DEMONSTRATION:
   - Calculate total cost of ownership for security
   - Demonstrate ROI of proactive security measures
   - Create business cases for strategic investments
   - Track and report on strategic progress

Focus on shifting from reactive to proactive, cost-focused to value-focused approaches.
Create compelling business cases for long-term security investments.""",
            tools=[self.code_interpreter.code_interpreter]
        )

    def _create_legacy_system_agent(self) -> Agent:
        """Agent for managing legacy systems and technical debt"""
        return Agent(
            model=MODEL_ID,
            session_manager=self.session_manager,
            system_prompt="""You are a Legacy Systems Specialist agent. Your role is to:

1. LEGACY SYSTEM ANALYSIS:
   - Inventory and categorize legacy systems
   - Assess patchability and supportability
   - Identify critical vulnerabilities in legacy systems
   - Map dependencies and business criticality

2. RISK MITIGATION:
   - Design compensating controls for unpatchable systems
   - Recommend network segmentation strategies
   - Create monitoring and detection capabilities
   - Develop incident response procedures

3. MODERNIZATION PLANNING:
   - Create technical debt reduction roadmaps
   - Prioritize systems for replacement or upgrade
   - Design migration strategies with security considerations
   - Calculate costs and benefits of modernization

Focus on practical approaches to manage security risks in legacy environments.
Balance immediate risk reduction with long-term modernization goals.""",
            tools=[self.code_interpreter.code_interpreter]
        )

    def _create_patch_management_agent(self) -> Agent:
        """Agent for optimizing patch management processes"""
        return Agent(
            model=MODEL_ID,
            session_manager=self.session_manager,
            system_prompt="""You are a Patch Management Specialist agent. Your role is to:

1. PATCH PROCESS OPTIMIZATION:
   - Analyze current patch management workflows
   - Identify testing and deployment bottlenecks
   - Design automated patch management pipelines
   - Create risk-based patching strategies

2. TESTING AUTOMATION:
   - Recommend automated testing frameworks
   - Design staged deployment processes
   - Create rollback procedures and safeguards
   - Implement continuous monitoring

3. COMPLEX ENVIRONMENT MANAGEMENT:
   - Handle dependencies and interconnected systems
   - Coordinate patches across multiple environments
   - Manage maintenance windows and downtime
   - Create emergency patching procedures

Focus on reducing time-to-patch while maintaining system stability.
Design scalable, automated approaches for complex environments.""",
            tools=[self.code_interpreter.code_interpreter]
        )

@app.entrypoint
def vulnerability_management_orchestrator(payload, context):
    """Main entry point for vulnerability management system"""
    
    # Get session context
    session_id = getattr(context, 'session_id', 'default-vm-session')
    actor_id = payload.get('actor_id', 'vm-team')
    
    # Configure memory for persistent knowledge
    memory_config = AgentCoreMemoryConfig(
        memory_id=MEMORY_ID,
        session_id=session_id,
        actor_id=actor_id,
        retrieval_config={
            f"/vm/{actor_id}/assets": RetrievalConfig(top_k=5, relevance_score=0.6),
            f"/vm/{actor_id}/vulnerabilities": RetrievalConfig(top_k=10, relevance_score=0.7),
            f"/vm/{actor_id}/processes": RetrievalConfig(top_k=3, relevance_score=0.5),
            f"/vm/{actor_id}/metrics": RetrievalConfig(top_k=5, relevance_score=0.6)
        }
    )
    
    # Initialize orchestrator
    orchestrator = VulnerabilityManagementOrchestrator(session_id, memory_config)
    
    # Parse request
    request_type = payload.get('request_type', 'general')
    query = payload.get('query', '')
    data = payload.get('data', {})
    
    # Route to appropriate agent based on request type
    if request_type == 'asset_discovery':
        result = orchestrator.asset_discovery_agent(
            f"Asset Discovery Request: {query}\nData: {data}"
        )
    elif request_type == 'risk_prioritization':
        result = orchestrator.risk_prioritization_agent(
            f"Risk Prioritization Request: {query}\nVulnerability Data: {data}"
        )
    elif request_type == 'resource_optimization':
        result = orchestrator.resource_optimization_agent(
            f"Resource Optimization Request: {query}\nResource Data: {data}"
        )
    elif request_type == 'collaboration':
        result = orchestrator.collaboration_agent(
            f"Collaboration Request: {query}\nTeam Data: {data}"
        )
    elif request_type == 'strategic_planning':
        result = orchestrator.strategic_planning_agent(
            f"Strategic Planning Request: {query}\nOrganization Data: {data}"
        )
    elif request_type == 'legacy_systems':
        result = orchestrator.legacy_system_agent(
            f"Legacy Systems Request: {query}\nSystem Data: {data}"
        )
    elif request_type == 'patch_management':
        result = orchestrator.patch_management_agent(
            f"Patch Management Request: {query}\nPatch Data: {data}"
        )
    else:
        # General vulnerability management query - route to most appropriate agent
        result = orchestrator._route_general_query(query, data)
    
    return {
        "response": result.message.get('content', [{}])[0].get('text', str(result)),
        "session_id": session_id,
        "request_type": request_type
    }

if __name__ == "__main__":
    app.run()